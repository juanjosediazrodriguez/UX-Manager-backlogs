{% extends "base.html" %}
{% load static %}
{% block title %}Calificaciones - {{ company.name }}{% endblock %}
{% block content %}
  <section aria-labelledby="ratings-overview" class="space-y-10">
    <header class="space-y-3">
      <p class="text-sm font-semibold uppercase tracking-wide text-brand-600">Detalle</p>
      <h1 id="ratings-overview" class="text-3xl font-semibold text-neutral-900">Calificaciones de {{ company.name }}</h1>
      <p class="max-w-3xl text-neutral-700">{{ company_description }}</p>
      <div class="flex flex-wrap gap-3 text-xs text-neutral-600">
        <span class="rounded-full border border-neutral-300 bg-neutral-100 px-3 py-1">Industria: {{ company.industry }}</span>
        <span class="rounded-full border border-neutral-300 bg-neutral-100 px-3 py-1">Ubicación: {{ company.location }}</span>
        <span class="rounded-full border border-brand-200 bg-brand-50 px-3 py-1">Tendencia: {{ company.trend }}</span>
        <span class="rounded-full border border-neutral-300 bg-neutral-100 px-3 py-1">{{ total_comment_count }} reseñas registradas</span>
      </div>
    </header>

    <div class="grid gap-6 lg:grid-cols-[1.4fr_1fr]">
      <article class="space-y-6 rounded-xl border bg-white p-6 shadow-sm" aria-labelledby="ratings-summary">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 id="ratings-summary" class="text-xl font-semibold text-neutral-900">Promedio general</h2>
            <p class="text-sm text-neutral-700">Comparado con {{ industry_size }} empresas del sector {{ company.industry|lower }}. Promedio del sector: {{ industry_average|floatformat:1 }}.</p>
          </div>
          
        </div>

        <div class="relative overflow-hidden rounded-3xl border bg-neutral-50 p-6">
          <div class="grid grid-cols-5 gap-4 text-center" aria-hidden="true">
            <div class="space-y-2">
              <span class="mx-auto block h-10 w-10 rounded-full bg-red-200 border border-red-300"></span>
              <span class="text-xs font-medium text-neutral-500">Muy bajo</span>
            </div>
            <div class="space-y-2">
              <span class="mx-auto block h-10 w-10 rounded-full bg-orange-200 border border-orange-300"></span>
              <span class="text-xs font-medium text-neutral-500">Bajo</span>
            </div>
            <div class="space-y-2">
              <span class="mx-auto block h-10 w-10 rounded-full bg-yellow-200 border border-yellow-300"></span>
              <span class="text-xs font-medium text-neutral-500">Medio</span>
            </div>
            <div class="space-y-2">
              <span class="mx-auto block h-10 w-10 rounded-full bg-lime-200 border border-lime-300"></span>
              <span class="text-xs font-medium text-neutral-500">Alto</span>
            </div>
            <div class="space-y-2">
              <span class="mx-auto block h-10 w-10 rounded-full bg-emerald-300 border border-emerald-400"></span>
              <span class="text-xs font-medium text-neutral-500">Excelente</span>
            </div>
          </div>
          <div class="mt-6 h-2 rounded-full bg-neutral-200" role="presentation">
            <div class="h-full rounded-full bg-brand-500" style="width: {{ score_percent|floatformat:0 }}%;"></div>
          </div>
          <div class="mt-4 flex items-end justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-neutral-500">Promedio</p>
              <p class="text-2xl font-semibold text-brand-700">{{ comment_average|floatformat:1 }} / 5</p>
            </div>
            <div class="text-right">
              <p class="text-xs uppercase tracking-wide text-neutral-500">Reseñas analizadas</p>
              <p class="text-sm font-medium text-neutral-700">{{ total_comment_count }} reseñas consideradas</p>
            </div>
          </div>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          {% for item in rating_distribution %}
            <dl class="rounded-lg border bg-neutral-50 p-4 space-y-2">
              <dt class="text-xs uppercase tracking-wide text-neutral-500">{{ item.label }}</dt>
              <dd class="text-xl font-semibold text-neutral-900">{{ item.count }}</dd>
              <dd class="text-sm text-neutral-600">{{ item.percentage }}% de las reseñas recopiladas</dd>
            </dl>
          {% endfor %}
        </div>
      </article>

      <aside class="space-y-5">
        <section class="space-y-4 rounded-xl border bg-white p-6 shadow-sm" aria-labelledby="comment-filter-title">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 id="comment-filter-title" class="text-lg font-semibold text-neutral-900">Comentarios</h2>
              <p class="text-sm text-neutral-600">Filtra por percepción para mapear focos rápidos.</p>
            </div>
            <span class="text-xs uppercase tracking-wide text-neutral-500">{{ filtered_comments|length }} de {{ total_comment_count }}</span>
          </div>
          <nav aria-label="Filtro de comentarios" class="flex flex-wrap gap-2">
            {% for option in comment_filters %}
              <a href="{{ option.url }}" class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs font-medium {% if option.is_active %}border-brand-500 bg-brand-50 text-brand-700{% else %}border-neutral-300 text-neutral-600 hover:border-brand-300{% endif %}">
                {{ option.label }}
                <span class="rounded-full bg-white px-2 py-0.5 text-[11px] text-neutral-500">{{ option.count }}</span>
                <span class="sr-only">({{ option.description }})</span>
              </a>
            {% endfor %}
          </nav>
          {% if filtered_comments %}
            <ul class="space-y-4" aria-label="Lista de comentarios">
              {% for comment in filtered_comments %}
                <li class="rounded-lg border border-neutral-200 bg-neutral-50 p-4">
                  <div class="flex items-start justify-between gap-3">
                    <p class="text-sm font-medium text-neutral-900">{{ comment.author }}</p>
                    <span class="text-xs text-neutral-500">{{ comment.timestamp_label }}</span>
                  </div>
                  <p class="mt-2 text-sm text-neutral-700">"{{ comment.quote }}"</p>
                  <div class="mt-3 flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-neutral-500">
                    <span class="text-yellow-500" aria-hidden="true">
                      {% for _ in "12345"|make_list %}
                        {% if forloop.counter <= comment.rating %}&#9733;{% else %}&#9734;{% endif %}
                      {% endfor %}
                    </span>
                    <span aria-label="Calificacion">{{ comment.rating }} estrellas</span>
                    <span aria-hidden="true">|</span>
                    <span>{{ comment.responses_label }}</span>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="rounded-lg border border-dashed border-neutral-300 bg-neutral-50 p-4 text-sm text-neutral-600">No hay comentarios en esta categoria. Prueba con otro filtro.</p>
          {% endif %}

          <div class="rounded-lg border border-brand-500 bg-brand-100 p-4 space-y-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h3 class="text-sm font-semibold text-neutral-900">Publicar un comentario</h3>
                <p class="text-xs text-neutral-600">Comparte percepciones para enriquecer el radar del equipo.</p>
              </div>
                          </div>
            {% if request.user.is_authenticated %}
              {% if form_errors %}
                <div class="rounded-md border border-red-300 bg-red-50 px-3 py-2 text-xs text-red-700">
                  {% for error in form_errors %}
                    <p>- {{ error }}</p>
                  {% endfor %}
                </div>
              {% endif %}
              <form method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="comentarios" value="{{ selected_comment_filter }}" />
                <label class="text-xs uppercase tracking-wide text-neutral-500" for="comment-body">Escribe comentario</label>
                <textarea id="comment-body" name="comment" rows="4" class="mt-1 w-full rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm text-neutral-900 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200" placeholder="Describe la situación, impacto y oportunidades" required></textarea>
                <div class="mt-3 flex flex-wrap items-center gap-3">
                  <label class="text-xs uppercase tracking-wide text-neutral-500" for="comment-rating">Calificación</label>
                  <select id="comment-rating" name="rating" class="rounded-md border border-neutral-300 bg-white px-3 py-2 text-sm text-neutral-900 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-200">
                    <option value="5">5 estrellas</option>
                    <option value="4">4 estrellas</option>
                    <option value="3">3 estrellas</option>
                    <option value="2">2 estrellas</option>
                    <option value="1">1 estrella</option>
                  </select>
                  <button type="submit" class="ml-auto inline-flex items-center gap-2 rounded-md bg-brand-600 px-4 py-2 text-sm font-medium text-white hover:bg-brand-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500">Publicar</button>
                </div>
                <p class="mt-2 text-xs text-neutral-500">El comentario aparecerá aquí junto a los demás. Esta acción es parte del prototipo funcional.</p>
              </form>
            {% else %}
              <p class="text-sm text-neutral-600">Inicia sesión para escribir un comentario y sumarlo al análisis.</p>
              <a href="{% url 'account_login' %}?next={{ request.get_full_path|urlencode }}" class="inline-flex items-center gap-2 rounded-md border border-brand-500 px-4 py-2 text-sm font-medium text-brand-700 hover:bg-brand-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-500">Iniciar sesión</a>
            {% endif %}
          </div>
        </section>

        <section class="space-y-4 rounded-xl border bg-white p-6 shadow-sm" aria-labelledby="ratings-notes">
          <div class="flex items-center justify-between">
            <h2 id="ratings-notes" class="text-lg font-semibold text-neutral-900">Cualidades del talento ideal</h2>
                      </div>
          <ul class="space-y-4" aria-label="Cualidades solicitadas para el equipo">
            {% for quality in candidate_qualities %}
              <li class="rounded-lg border border-neutral-200 bg-neutral-50 p-4 text-sm text-neutral-700">{{ quality }}</li>
            {% endfor %}
          </ul>
          <a href="/" class="inline-flex items-center gap-2 text-sm font-medium text-brand-700 hover:underline">Volver al buscador -></a>
        </section>
      </aside>
    </div>

  </section>
{% endblock %}
